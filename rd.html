<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche & Développement (sans préfixe)</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #fileInput{max-width:300px}
    .appareil-table{margin-bottom:2rem}
    #loadingMsg{display:none;font-style:italic;color:#666}
  </style>
</head>
<body class="p-4 bg-light">
  <!-- navbar identique -->
  … <!--   (conserve ta navbar telle quelle) -->

  <div class="container">
    <h1 class="mb-4">Recherche & Développement</h1>
    <p>Entrez plusieurs appareils sans préfixe <code>A36-C-</code> (séparés par espace, virgule ou point-virgule)…</p>
    <p id="baseIndicator" class="text-muted">Base : inconnue</p>
    <p id="loadingMsg">⏳ Patientez, chargement du fichier NEC…</p>

    <div class="mb-3">
      <label class="form-label">Charger un fichier NEC (.xlsb) :</label>
      <input type="file" id="fileInput" accept=".xlsb" class="form-control">
    </div>

    <div class="mb-3">
      <label class="form-label">Appareils :</label>
      <textarea id="appareilsInput" rows="2" class="form-control"
        placeholder="Ex : VEDDH603C1 TR1234 STT701"></textarea>
    </div>

    <button class="btn btn-primary mb-3" id="btnSearch">Rechercher</button>
    <button class="btn btn-success mb-3 ms-2" id="btnExportAll">Exporter tout</button>
    <button class="btn btn-warning mb-3 ms-2" id="btnExportNonTires">Exporter non tirés</button>
    <button class="btn btn-info mb-3 ms-2" id="btnExportOkAppareils">Exporter appareils OK</button>

    <div id="resultsArea"></div>
  </div>

  <script>
    /* -------- helpers -------- */
    const strip = s => String(s||"").replace(/^A36-C-/i,"").toUpperCase();
    const cols   = ["APA","APO","PT_CBL","RESP_TIRAGE","GAM","STT_CBL_BORD",
                    "LOCAL_APA","LOT_MTG_APA","LOCAL_APO","LOT_MTG_APO"];

    let cables=[], globalResults=[], currentBase="inconnue";
    window.addEventListener("load",init);

    function init(){
      q("#fileInput").addEventListener("change",handleXlsb);
      q("#btnSearch").onclick = searchMulti;
      q("#btnExportAll").onclick      = ()=>exportExcel(false);
      q("#btnExportNonTires").onclick = ()=>exportExcel(true);
      q("#btnExportOkAppareils").onclick = exportOkApps;
      loadJsonDefault();
    }

    const q = s=>document.querySelector(s);
    function updateBase(){ q("#baseIndicator").textContent=`Base : ${currentBase}`; }

    /* ---------- 1. JSON par défaut ---------- */
    async function loadJsonDefault(){
      currentBase="JSON par défaut"; updateBase();
      const merge={};
      for(const col of cols){
        try{
          const res = await fetch(`json/cables_${col}.json`);
          if(!res.ok) continue;
          const rows=await res.json();
          rows.forEach(r=>{
            const id=strip(r.CBL);
            if(!merge[id]) merge[id]={CBL:id};
            merge[id][col]=typeof r[col]==="string"?strip(r[col]):r[col];
          });
        }catch(e){console.warn("load",col,e)}
      }
      cables=Object.values(merge);
    }

    /* ---------- 2. Chargement XLSB ---------- */
    function handleXlsb(evt){
      const f=evt.target.files[0]; if(!f) return;
      q("#loadingMsg").style.display="block";
      const r=new FileReader();
      r.onload=e=>parseXlsb(new Uint8Array(e.target.result));
      r.readAsArrayBuffer(f);
    }
    function parseXlsb(buf){
      try{
        const wb=XLSX.read(buf,{type:"array"});
        const sheet=wb.SheetNames.find(n=>/cables/i.test(n));
        if(!sheet) return alert("Feuille 'Cables' non trouvée");
        const raw=XLSX.utils.sheet_to_json(wb.Sheets[sheet],{defval:""});
        const merge={};
        raw.forEach(row=>{
          const id=strip(row.CBL);
          if(!merge[id]) merge[id]={CBL:id};
          cols.forEach(c=>merge[id][c]=typeof row[c]==="string"?strip(row[c]):row[c]);
        });
        cables=Object.values(merge);
        currentBase="NEC chargé manuellement"; updateBase();
        alert(`NEC chargé : ${cables.length} câbles`);
      }catch(e){alert("Erreur XLSB : "+e.message);}
      finally{q("#loadingMsg").style.display="none";}
    }

    /* ---------- 3. Recherche multi-appareils ---------- */
    function searchMulti(){
      const list=q("#appareilsInput").value
                   .split(/[,;\\s]+/).filter(Boolean).map(strip);
      if(!list.length) return;
      const zone=q("#resultsArea"); zone.innerHTML=""; globalResults=[];
      list.forEach(app=>{
        const found=cables.filter(c=>c.APA===app||c.APO===app);
        zone.innerHTML+=tableApp(app,found);
        found.forEach(c=>{
          const isAPA=c.APA===app;
          globalResults.push({Appareil:app,Câble:c.CBL,PT_CBL:c.PT_CBL||\"\",GAM:c.GAM||\"\",Statut:c.STT_CBL_BORD||\"\",\n            RespTirage:c.RESP_TIRAGE||\"\",Local:isAPA?c.LOCAL_APA:c.LOCAL_APO,Lot:isAPA?c.LOT_MTG_APA:c.LOT_MTG_APO});\n        });\n      });\n    }\n    function tableApp(app,rows){\n      if(!rows.length) return `<h4>${app}</h4><div class=\"alert alert-warning\">Aucun câble trouvé.</div>`;\n      const any=rows[0];\n      const loc=any.APA===app?any.LOCAL_APA:any.LOCAL_APO;\n      const lot=any.APA===app?any.LOT_MTG_APA:any.LOT_MTG_APO;\n      let tr=\"\";\n      rows.forEach(c=>{\n        tr+=`<tr><td>${app}</td><td>${c.CBL}</td><td>${c.PT_CBL||\"-\"}</td><td>${c.RESP_TIRAGE||\"-\"}</td><td>${c.GAM||\"-\"}</td><td>${c.STT_CBL_BORD||\"-\"}</td></tr>`;\n      });\n      return `<div class=\"appareil-table\"><h4>${app} – ${rows.length} câble(s)<br><small class=\"text-muted\">Lot : ${lot||\"-\"} / Local : ${loc||\"-\"}</small></h4><div class=\"table-responsive\"><table class=\"table table-bordered\"><thead class=\"table-light\"><tr><th>Appareil</th><th>Câble</th><th>PT_CBL</th><th>Resp. Tirage</th><th>GAM</th><th>Statut</th></tr></thead><tbody>${tr}</tbody></table></div></div>`;\n    }\n\n    /* ---------- 4. Export Excel ---------- */\n    function exportExcel(nonTires){\n      let arr=nonTires?globalResults.filter(r=>r.Statut.toUpperCase()!==\"T\"):globalResults;\n      if(!arr.length) return alert(\"Aucune donnée à exporter.\");\n      const ws=XLSX.utils.json_to_sheet(arr,{header:[\"Appareil\",\"Câble\",\"PT_CBL\",\"GAM\",\"Statut\",\"RespTirage\",\"Local\",\"Lot\"]});\n      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,\"Export\");\n      XLSX.writeFile(wb,nonTires?\"non_tires.xlsx\":\"all.xlsx\");\n    }\n\n    /* ---------- 5. Export appareils OK ---------- */\n    function exportOkApps(){\n      const map={};\n      globalResults.forEach(r=>{\n        const d=map[r.Appareil]||(map[r.Appareil]={ok:true,loc:new Set(),lot:new Set()});\n        if(r.Statut.toUpperCase()!==\"T\") d.ok=false;\n        if(r.Local) d.loc.add(r.Local); if(r.Lot) d.lot.add(r.Lot);\n      });\n      const arr=Object.entries(map).filter(([,d])=>d.ok).map(([app,d])=>({Appareil:app,Local:[...d.loc].join(\", \"),Lot:[...d.lot].join(\", \"),SGDTEL_OK:\"OK\"}));\n      if(!arr.length) return alert(\"Aucun appareil avec tous câbles T.\");\n      const ws=XLSX.utils.json_to_sheet(arr,{header:[\"Appareil\",\"Local\",\"Lot\",\"SGDTEL_OK\"]});\n      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,\"OK\"); XLSX.writeFile(wb,\"appareils_allT.xlsx\");\n    }\n  </script>\n  <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n</body>\n</html>"}]}
